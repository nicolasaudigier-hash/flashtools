<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashFacture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --theme-primary: #000000;
            --theme-secondary: #1f1f1f;
            --theme-light: #f5f5f5;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--gray-900);
            background: #0a0e27;
            padding: 20px;
        }
        
        .container { max-width: 1100px; margin: 0 auto; }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header {
            background: var(--theme-primary);
            color: white;
            padding: 30px 40px;
        }
        .header h1 { font-size: 1.8em; font-weight: 600; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 1em; }
        
        .content { padding: 40px; }
        
        .section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--gray-200);
        }
        .section:last-child { border-bottom: none; }
        
        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--theme-primary);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
            font-size: 0.95em;
        }
        .form-group small {
            display: block;
            color: var(--gray-600);
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }
        textarea { min-height: 80px; resize: vertical; }
        
        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .radio-item:hover { border-color: var(--theme-primary); background: var(--gray-50); }
        .radio-item input[type="radio"] { accent-color: var(--theme-primary); width: 16px; height: 16px; }
        .radio-item label { cursor: pointer; font-weight: 500; margin: 0; }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
        }
        .checkbox-item:hover { border-color: var(--theme-primary); }
        .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; }
        
        .lines-container { margin: 20px 0; }
        .line-item {
            display: grid;
            grid-template-columns: 2fr 0.6fr 0.8fr 0.8fr 0.6fr 50px;
            gap: 10px;
            margin-bottom: 12px;
            align-items: end;
            background: var(--gray-50);
            padding: 15px;
            border-radius: 4px;
        }
        .discount-input { position: relative; }
        .discount-input input { padding-right: 25px; }
        .discount-input::after {
            content: '%';
            position: absolute;
            right: 12px;
            bottom: 12px;
            color: var(--gray-600);
            font-weight: 600;
        }
        .remove-line {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 12px;
            font-weight: 600;
            height: 42px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--theme-primary); color: white; }
        .btn-primary:hover { background: var(--theme-secondary); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-800); }
        .btn-block { width: 100%; padding: 16px; font-size: 1.05em; }
        
        .totals {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 1em;
        }
        .total-line.grand-total {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--theme-primary);
            border-top: 2px solid var(--gray-300);
            margin-top: 12px;
            padding-top: 15px;
        }
        
        .info-box {
            background: var(--gray-50);
            border-left: 3px solid var(--theme-primary);
            padding: 18px;
            border-radius: 4px;
            margin: 20px 0;
            font-size: 0.95em;
        }
        
        .logo-upload {
            border: 2px dashed var(--gray-300);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .logo-upload:hover { border-color: var(--theme-primary); background: var(--gray-50); }
        .logo-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .logo-preview-zone {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 4px;
            min-height: 100px;
            display: none;
        }
        .logo-preview-zone img {
            max-width: 200px;
            max-height: 80px;
            object-fit: contain;
        }
        
        /* PREVIEW */
        .preview-container {
            background: var(--gray-100);
            padding: 30px;
            border-radius: 4px;
            margin: 30px 0;
        }
        .preview-page {
            background: white;
            padding: 50px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            border: 1px solid var(--gray-200);
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }
        
        .preview-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .preview-logo-img {
            max-width: 80px;
            max-height: 40px;
            object-fit: contain;
        }
        
        .preview-company {
            flex: 1;
        }
        
        .preview-company-name {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }
        .preview-company-info {
            font-size: 0.75em;
            color: var(--gray-700);
            line-height: 1.5;
        }
        .preview-company-info p {
            margin: 2px 0;
        }
        
        .preview-doc-info {
            text-align: right;
            min-width: 180px;
        }
        .preview-doc-type {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--theme-primary);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .preview-doc-number {
            font-size: 1em;
            color: var(--gray-600);
            font-weight: 500;
        }
        .preview-doc-dates {
            margin-top: 12px;
            font-size: 0.85em;
            color: var(--gray-700);
        }
        .preview-doc-dates div {
            margin: 4px 0;
        }
        
        .preview-parties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }
        .preview-party h4 {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            margin-bottom: 10px;
            font-weight: 700;
        }
        .preview-party p {
            margin: 3px 0;
            font-size: 0.9em;
            color: var(--gray-800);
        }
        .preview-party strong {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .preview-note {
            font-size: 0.75em;
            color: var(--gray-600);
            font-style: italic;
            margin-bottom: 20px;
            padding: 8px 0;
            border-top: 1px dashed var(--gray-300);
        }
        .preview-note.with-content {
            border-bottom: none;
        }
        .preview-note.empty {
            border-bottom: 1px dashed var(--gray-300);
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9em;
        }
        .preview-table thead {
            background: var(--theme-light);
        }
        .preview-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--theme-primary);
            color: var(--theme-secondary);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .preview-table td {
            padding: 10px;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-800);
            vertical-align: top;
        }
        .preview-table td:nth-child(2),
        .preview-table td:nth-child(3),
        .preview-table td:nth-child(4),
        .preview-table td:nth-child(5),
        .preview-table td:nth-child(6) {
            text-align: right;
        }
        .preview-table th:nth-child(2),
        .preview-table th:nth-child(3),
        .preview-table th:nth-child(4),
        .preview-table th:nth-child(5),
        .preview-table th:nth-child(6) {
            text-align: right;
        }
        
        .preview-totals {
            margin-left: auto;
            width: 320px;
            margin-top: 20px;
        }
        .preview-total-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.95em;
        }
        .preview-total-line.grand {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--theme-primary);
            border-top: 2px solid var(--gray-300);
            margin-top: 12px;
            padding-top: 15px;
        }
        
        .preview-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            font-size: 0.75em;
            color: var(--gray-600);
            line-height: 1.6;
        }
        .preview-footer div {
            margin: 6px 0;
        }
        
        .stamp-paid {
            position: absolute;
            bottom: 140px;
            right: 80px;
            border: 3px solid #dc2626;
            color: #dc2626;
            padding: 10px 20px;
            font-size: 1.5em;
            font-weight: 700;
            transform: rotate(-8deg);
            opacity: 0.5;
            border-radius: 4px;
            letter-spacing: 2px;
        }
        
        @media (max-width: 768px) {
            body { background: #0a0e27; }
            .content { padding: 25px 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .line-item { grid-template-columns: 1fr; }
            .preview-header { flex-direction: column; gap: 20px; }
            .preview-left { flex-direction: column; align-items: flex-start; }
            .preview-doc-info { text-align: left; }
            .preview-parties { grid-template-columns: 1fr; gap: 25px; }
            .preview-page { padding: 30px 20px; }
            .logo-controls-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>FlashFacture</h1>
                <p>Génération de factures professionnelles</p>
            </div>

            <div class="content">
                <div class="info-box">
                    <p><strong>Mode sans stockage</strong> - Remplissez le formulaire et générez votre PDF. Aucune donnée n'est sauvegardée.</p>
                </div>

                <!-- TYPE -->
                <div class="section">
                    <div class="section-title">Type de document</div>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="typeInvoice" name="docType" value="invoice" checked onchange="updateDocType()">
                            <label for="typeInvoice">Facture</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="typeQuote" name="docType" value="quote" onchange="updateDocType()">
                            <label for="typeQuote">Devis</label>
                            <span style="display:inline-block;margin-left:8px;cursor:help;color:#4f46e5;font-weight:600;font-size:14px;position:relative" title="Pour avoir une valeur juridique, un devis doit être signé par le client avec la mention 'Bon pour accord'">ⓘ</span>
                        </div>
                    </div>
                </div>

                <!-- LOGO -->
                <div class="section">
                    <div class="section-title">Logo (optionnel)</div>
                    
                    <div class="logo-upload" onclick="document.getElementById('logoInput').click()">
                        <p>Cliquez pour ajouter un logo</p>
                        <input type="file" id="logoInput" accept="image/*" style="display: none" onchange="handleLogo(event)">
                    </div>
                    
                    <div id="logoControls" style="display: none;">
                        <div class="logo-controls-grid">
                            <div class="form-group">
                                <label>Position</label>
                                <select id="logoPosition" onchange="updatePreview()">
                                    <option value="position1">Position 1 : Marge</option>
                                    <option value="position2">Position 2 : Dessus</option>
                                    <option value="position3">Position 3 : Centre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Taille (%)</label>
                                <input type="range" id="logoSize" min="30" max="150" value="100" oninput="updateLogoPreview()">
                                <small id="logoSizeValue">100%</small>
                            </div>
                            <div class="form-group">
                                <label>Opacité (%)</label>
                                <input type="range" id="logoOpacity" min="10" max="100" value="100" oninput="updateLogoPreview()">
                                <small id="logoOpacityValue">100%</small>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-secondary" onclick="removeLogo()">Retirer logo</button>
                            </div>
                        </div>
                        
                        <div class="logo-preview-zone" id="logoPreviewZone">
                            <img id="logoPreviewImg" src="" alt="Aperçu logo">
                        </div>
                    </div>
                </div>

                <!-- ENTREPRISE -->
                <div class="section">
                    <div class="section-title">Vos informations</div>
                    
                    <div class="form-group">
                        <label>Nom de votre entreprise *</label>
                        <input type="text" id="companyName" placeholder="SARL Mon Entreprise" oninput="updatePreview()">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>SIRET</label>
                            <input type="text" id="companySiret" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>N° TVA intracommunautaire</label>
                            <input type="text" id="companyVAT" oninput="updatePreview()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Adresse</label>
                        <textarea id="companyAddress" oninput="updatePreview()"></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="companyEmail" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="text" id="companyPhone" oninput="updatePreview()">
                        </div>
                    </div>
                </div>

                <!-- CLIENT -->
                <div class="section">
                    <div class="section-title">Client</div>
                    
                    <div class="form-group">
                        <label>Nom du client *</label>
                        <input type="text" id="clientName" oninput="updatePreview()">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="text" id="clientPhone" oninput="updatePreview()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Adresse de facturation</label>
                        <textarea id="clientAddress" oninput="updatePreview()"></textarea>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="differentDelivery" onchange="toggleDelivery()">
                        <label for="differentDelivery">Adresse de livraison différente</label>
                    </div>

                    <div id="deliveryBlock" style="display: none; margin-top: 15px;">
                        <div class="form-group">
                            <label>Adresse de livraison</label>
                            <textarea id="deliveryAddress" oninput="updatePreview()"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Note optionnelle</label>
                        <input type="text" id="optionalNote" placeholder="Ex: Commande n°, Projet..." oninput="updatePreview()">
                    </div>
                </div>

                <!-- NUMÉRO -->
                <div class="section">
                    <div class="section-title">Numéro et dates</div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label><span id="docNumberLabel">Numéro de facture</span> *</label>
                            <input type="text" id="docNumber" placeholder="FA-2025-001" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Date d'émission</label>
                            <input type="date" id="docDate" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label><span id="dueDateLabel">Date d'échéance</span></label>
                            <input type="date" id="dueDate" oninput="updatePreview()">
                        </div>
                    </div>
                </div>

                <!-- LIGNES -->
                <div class="section">
                    <div class="section-title">Prestations / Produits</div>
                    <div id="linesContainer" class="lines-container"></div>
                    <button class="btn btn-secondary" onclick="addLine()">+ Ajouter une ligne</button>

                    <div class="totals">
                        <div class="total-line">
                            <span>Total HT :</span>
                            <strong id="totalHT">0.00 €</strong>
                        </div>
                        <div class="total-line">
                            <span>Total TVA :</span>
                            <strong id="totalVAT">0.00 €</strong>
                        </div>
                        <div class="total-line grand-total">
                            <span>Total TTC :</span>
                            <strong id="totalTTC">0.00 €</strong>
                        </div>
                    </div>
                </div>

                <!-- OPTIONS -->
                <div class="section">
                    <div class="section-title">Options</div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Thème de couleur</label>
                            <select id="colorTheme" onchange="applyTheme(); updatePreview();">
                                <option value="black" selected>Noir</option>
                                <option value="indigo">Indigo</option>
                                <option value="blue">Bleu</option>
                                <option value="terracotta">Terracotta</option>
                                <option value="emerald">Émeraude</option>
                                <option value="violet">Violet</option>
                                <option value="rouge">Rouge</option>
                                <option value="cyan">Cyan</option>
                                <option value="or">Or</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mode de paiement</label>
                            <select id="paymentMode" onchange="updatePreview()">
                                <option value="Virement bancaire">Virement bancaire</option>
                                <option value="Chèque">Chèque</option>
                                <option value="Espèces">Espèces</option>
                                <option value="Carte bancaire">Carte bancaire</option>
                                <option value="Prélèvement">Prélèvement</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Échéance de paiement</label>
                        <select id="paymentTerms" onchange="updatePreview()">
                            <option value="">Aucune mention</option>
                            <option value="À la livraison">À la livraison</option>
                            <option value="Payable à 30 jours fin de mois">Payable à 30 jours fin de mois</option>
                            <option value="Payable à 30 jours">Payable à 30 jours</option>
                            <option value="Payable à 60 jours">Payable à 60 jours</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Mention TVA</label>
                        <select id="vatMention" onchange="updatePreview()">
                            <option value="">Aucune mention spéciale</option>
                            <option value="article293b">TVA non applicable, selon l'article 293B du code général des impôts</option>
                            <option value="autoliquidation">TVA due par le preneur assujetti ; autoliquidation en application de l'article 242 nonies A, I-13° de l'annexe II au CGI</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Acompte versé (optionnel)</label>
                        <input type="number" id="deposit" step="0.01" placeholder="0.00" oninput="calculateTotals(); updatePreview();">
                    </div>

                    <div class="checkbox-item" id="paidCheckbox" style="display: none;">
                        <input type="checkbox" id="markAsPaid" onchange="updatePreview()">
                        <label for="markAsPaid">Marquer comme payée (tampon PAYÉ)</label>
                    </div>

                    <div class="form-group">
                        <label>Notes personnalisées (PDF uniquement)</label>
                        <textarea id="notes" placeholder="Conditions particulières, notes..."></textarea>
                    </div>
                </div>

                <!-- APERÇU -->
                <div class="section">
                    <div class="section-title">Aperçu</div>

                    <div class="preview-container">
                        <div class="preview-page" id="previewPage">
                            <div id="stampPaid" class="stamp-paid" style="display: none;">PAYÉ</div>
                            
                            <div id="previewLogoCenterTop" style="text-align:center;margin-bottom:20px;display:none;">
                                <img id="previewLogoCenterImg" class="preview-logo-img" style="display:none;" src="" alt="Logo">
                            </div>
                            
                            <div class="preview-header">
                                <div class="preview-left">
                                    <img id="previewLogoMain" class="preview-logo-img" style="display:none;" src="" alt="Logo">
                                    <div class="preview-company">
                                        <div class="preview-company-name" id="previewCompanyName">---</div>
                                        <div class="preview-company-info" id="previewCompanyInfo"></div>
                                    </div>
                                </div>
                                
                                <div id="previewLogoCenterMiddle" style="position:absolute;left:50%;transform:translateX(-50%);top:20px;display:none;">
                                    <img id="previewLogoCenterMiddleImg" class="preview-logo-img" style="display:none;" src="" alt="Logo">
                                </div>
                                
                                <div class="preview-doc-info">
                                    <div class="preview-doc-type" id="previewDocType">FACTURE</div>
                                    <div class="preview-doc-number" id="previewNumber">N° ---</div>
                                    <div class="preview-doc-dates">
                                        <div><strong>Date :</strong> <span id="previewDate">---</span></div>
                                        <div><strong><span id="previewDueLabel">Échéance</span> :</strong> <span id="previewDue">---</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="preview-parties">
                                <div class="preview-party">
                                    <h4>Client</h4>
                                    <div id="previewClient">---</div>
                                </div>
                                <div id="previewDelivery" style="display:none;">
                                    <div class="preview-party">
                                        <h4>Livraison</h4>
                                        <div id="previewDeliveryAddress">---</div>
                                    </div>
                                </div>
                            </div>

                            <div id="previewNote" class="preview-note" style="display: none;"></div>

                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th>DESCRIPTION</th>
                                        <th>QTÉ</th>
                                        <th>P.U. HT</th>
                                        <th>REM.</th>
                                        <th>TVA</th>
                                        <th>TOTAL HT</th>
                                    </tr>
                                </thead>
                                <tbody id="previewLines">
                                    <tr><td colspan="6" style="text-align: center; color: #999;">Aucune ligne</td></tr>
                                </tbody>
                            </table>

                            <div class="preview-totals">
                                <div class="preview-total-line">
                                    <span>Total HT :</span>
                                    <strong id="previewTotalHT">0.00 €</strong>
                                </div>
                                <div class="preview-total-line">
                                    <span>Total TVA :</span>
                                    <strong id="previewTotalVAT">0.00 €</strong>
                                </div>
                                <div class="preview-total-line grand">
                                    <span>Total TTC :</span>
                                    <strong id="previewTotalTTC">0.00 €</strong>
                                </div>
                                <div id="previewDepositLine" style="display: none; margin-top: 10px;">
                                    <div class="preview-total-line">
                                        <span>Acompte :</span>
                                        <strong id="previewDeposit">0.00 €</strong>
                                    </div>
                                    <div class="preview-total-line" style="font-weight: 700;">
                                        <span>Reste à payer :</span>
                                        <strong id="previewRemaining">0.00 €</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="preview-footer">
                                <div id="previewPaymentTerms" style="font-weight: 600;"></div>
                                <div id="previewPayment"></div>
                                <div id="previewVatMention" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GÉNÉRATION -->
                <button class="btn btn-primary btn-block" onclick="generatePDF()">
                    Générer la <span id="btnDocType">facture</span> PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        var lines = [];
        var logoData = null;
        var themes = {
            black: { 
                primary: '#000000',
                secondary: '#1f1f1f',
                light: '#f5f5f5',
                complementary: '#6366f1'
            },
            indigo: { 
                primary: '#4f46e5',
                secondary: '#4338ca',
                light: '#e0e7ff',
                complementary: '#eab308'
            },
            blue: { 
                primary: '#2563eb',
                secondary: '#1e40af',
                light: '#dbeafe',
                complementary: '#f97316'
            },
            terracotta: { 
                primary: '#d97706',
                secondary: '#b45309',
                light: '#fed7aa',
                complementary: '#0284c7'
            },
            emerald: {
                primary: '#059669',
                secondary: '#047857',
                light: '#d1fae5',
                complementary: '#dc2626'
            },
            violet: {
                primary: '#7c3aed',
                secondary: '#6d28d9',
                light: '#ddd6fe',
                complementary: '#facc15'
            },
            rouge: {
                primary: '#dc2626',
                secondary: '#b91c1c',
                light: '#fee2e2',
                complementary: '#059669'
            },
            cyan: {
                primary: '#06b6d4',
                secondary: '#0891b2',
                light: '#cffafe',
                complementary: '#f97316'
            },
            or: {
                primary: '#eab308',
                secondary: '#ca8a04',
                light: '#fef3c7',
                complementary: '#4f46e5'
            }
        };

        function init() {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('docDate').value = today;
            
            var dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            
            applyTheme();
            addLine();
            updatePreview();
        }

        function applyTheme() {
            var themeKey = document.getElementById('colorTheme').value;
            var theme = themes[themeKey];
            var root = document.documentElement;
            root.style.setProperty('--theme-primary', theme.primary);
            root.style.setProperty('--theme-secondary', theme.secondary);
            root.style.setProperty('--theme-light', theme.light);
        }

        function updateDocType() {
            var type = document.querySelector('input[name="docType"]:checked').value;
            var isInvoice = type === 'invoice';
            
            document.getElementById('docNumberLabel').textContent = isInvoice ? 'Numéro de facture' : 'Numéro de devis';
            document.getElementById('dueDateLabel').textContent = isInvoice ? "Date d'échéance" : 'Validité du devis';
            document.getElementById('btnDocType').textContent = isInvoice ? 'facture' : 'devis';
            document.getElementById('paidCheckbox').style.display = isInvoice ? 'flex' : 'none';
            
            updatePreview();
        }

        function handleLogo(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(event) {
                logoData = event.target.result;
                document.getElementById('logoPreviewImg').src = logoData;
                document.getElementById('logoControls').style.display = 'block';
                document.getElementById('logoPreviewZone').style.display = 'block';
                updateLogoPreview();
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        function updateLogoPreview() {
            var size = document.getElementById('logoSize').value;
            var opacity = document.getElementById('logoOpacity').value;
            document.getElementById('logoSizeValue').textContent = size + '%';
            document.getElementById('logoOpacityValue').textContent = opacity + '%';
            
            var img = document.getElementById('logoPreviewImg');
            img.style.transform = 'scale(' + (size/100) + ')';
            img.style.opacity = opacity/100;
            
            updatePreview();
        }

        function removeLogo() {
            logoData = null;
            document.getElementById('logoControls').style.display = 'none';
            document.getElementById('logoPreviewZone').style.display = 'none';
            document.getElementById('logoInput').value = '';
            updatePreview();
        }

        function toggleDelivery() {
            var show = document.getElementById('differentDelivery').checked;
            document.getElementById('deliveryBlock').style.display = show ? 'block' : 'none';
            updatePreview();
        }

        function addLine() {
            lines.push({
                id: Date.now() + Math.random(),
                description: '',
                quantity: 1,
                priceHT: 0,
                discount: 0,
                vat: 20
            });
            renderLines();
        }

        function renderLines() {
            var html = '';
            lines.forEach(function(line, index) {
                html += `
                    <div class="line-item">
                        <div>
                            <label style="font-size: 0.85em; margin-bottom: 5px; display:block;">Description</label>
                            <input type="text" placeholder="Désignation" value="${line.description}" 
                                   oninput="updateLine(${index}, 'description', this.value)">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; margin-bottom: 5px; display:block;">Qté</label>
                            <input type="number" value="${line.quantity}" min="0.01" step="0.01"
                                   oninput="updateLine(${index}, 'quantity', this.value)">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; margin-bottom: 5px; display:block;">P.U. HT</label>
                            <input type="number" value="${line.priceHT}" step="0.01"
                                   oninput="updateLine(${index}, 'priceHT', this.value)">
                        </div>
                        <div class="discount-input">
                            <label style="font-size: 0.85em; margin-bottom: 5px; display:block;">Remise</label>
                            <input type="number" value="${line.discount}" min="0" max="100" step="0.1"
                                   oninput="updateLine(${index}, 'discount', this.value)">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; margin-bottom: 5px; display:block;">TVA</label>
                            <select onchange="updateLine(${index}, 'vat', this.value)">
                                <option value="20" ${line.vat == 20 ? 'selected' : ''}>20%</option>
                                <option value="10" ${line.vat == 10 ? 'selected' : ''}>10%</option>
                                <option value="5.5" ${line.vat == 5.5 ? 'selected' : ''}>5.5%</option>
                                <option value="0" ${line.vat == 0 ? 'selected' : ''}>0%</option>
                            </select>
                        </div>
                        <button class="remove-line" onclick="removeLine(${index})">×</button>
                    </div>
                `;
            });
            document.getElementById('linesContainer').innerHTML = html;
            calculateTotals();
        }

        function updateLine(index, field, value) {
            if (field === 'quantity' || field === 'priceHT' || field === 'vat' || field === 'discount') {
                lines[index][field] = parseFloat(value) || 0;
            } else {
                lines[index][field] = value;
            }
            calculateTotals();
            updatePreview();
        }

        function removeLine(index) {
            lines.splice(index, 1);
            if (lines.length === 0) addLine();
            else renderLines();
        }

        function calculateTotals() {
            var totalHT = 0;
            var totalVAT = 0;
            
            lines.forEach(function(line) {
                var lineHT = line.quantity * line.priceHT;
                var discountAmount = lineHT * (line.discount / 100);
                var lineHTAfterDiscount = lineHT - discountAmount;
                totalHT += lineHTAfterDiscount;
                totalVAT += lineHTAfterDiscount * (line.vat / 100);
            });
            
            var totalTTC = totalHT + totalVAT;
            
            document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' €';
            document.getElementById('totalVAT').textContent = totalVAT.toFixed(2) + ' €';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' €';
        }

        function updatePreview() {
            var type = document.querySelector('input[name="docType"]:checked').value;
            var isInvoice = type === 'invoice';
            
            // Logo
            if (logoData) {
                var logoPos = document.getElementById('logoPosition').value;
                var size = document.getElementById('logoSize').value;
                var opacity = document.getElementById('logoOpacity').value;
                
                // Masquer tous les logos d'abord
                document.getElementById('previewLogoCenterTop').style.display = 'none';
                document.getElementById('previewLogoCenterImg').style.display = 'none';
                document.getElementById('previewLogoMain').style.display = 'none';
                document.getElementById('previewLogoCenterMiddle').style.display = 'none';
                document.getElementById('previewLogoCenterMiddleImg').style.display = 'none';
                
                // Position 2 : Dessus (centre tout en haut)
                if (logoPos === 'position2') {
                    document.getElementById('previewLogoCenterTop').style.display = 'block';
                    document.getElementById('previewLogoCenterImg').style.display = 'block';
                    document.getElementById('previewLogoCenterImg').src = logoData;
                    document.getElementById('previewLogoCenterImg').style.transform = 'scale(' + (size/100) + ')';
                    document.getElementById('previewLogoCenterImg').style.opacity = opacity/100;
                } 
                // Position 3 : Centre (dans le header, au centre)
                else if (logoPos === 'position3') {
                    document.getElementById('previewLogoCenterMiddle').style.display = 'block';
                    document.getElementById('previewLogoCenterMiddleImg').style.display = 'block';
                    document.getElementById('previewLogoCenterMiddleImg').src = logoData;
                    document.getElementById('previewLogoCenterMiddleImg').style.transform = 'scale(' + (size/100) + ')';
                    document.getElementById('previewLogoCenterMiddleImg').style.opacity = opacity/100;
                }
                // Position 1 : Marge (à droite des infos)
                else {
                    document.getElementById('previewLogoMain').style.display = 'block';
                    document.getElementById('previewLogoMain').src = logoData;
                    document.getElementById('previewLogoMain').style.transform = 'scale(' + (size/100) + ')';
                    document.getElementById('previewLogoMain').style.opacity = opacity/100;
                }
            } else {
                document.getElementById('previewLogoCenterTop').style.display = 'none';
                document.getElementById('previewLogoCenterImg').style.display = 'none';
                document.getElementById('previewLogoMain').style.display = 'none';
                document.getElementById('previewLogoCenterMiddle').style.display = 'none';
                document.getElementById('previewLogoCenterMiddleImg').style.display = 'none';
            }
            
            // Type et numéro
            document.getElementById('previewDocType').textContent = isInvoice ? 'FACTURE' : 'DEVIS';
            document.getElementById('previewNumber').textContent = 'N° ' + (document.getElementById('docNumber').value || '---');
            
            // Entreprise
            var companyName = document.getElementById('companyName').value;
            document.getElementById('previewCompanyName').textContent = companyName || '---';
            
            var companyHTML = '';
            var companyAddress = document.getElementById('companyAddress').value;
            if (companyAddress) companyHTML += '<p>' + companyAddress.replace(/\n/g, '<br>') + '</p>';
            var companyEmail = document.getElementById('companyEmail').value;
            if (companyEmail) companyHTML += '<p>' + companyEmail + '</p>';
            var companyPhone = document.getElementById('companyPhone').value;
            if (companyPhone) companyHTML += '<p>Tél: ' + companyPhone + '</p>';
            var companySiret = document.getElementById('companySiret').value;
            if (companySiret) companyHTML += '<p>SIRET: ' + companySiret + '</p>';
            var companyVAT = document.getElementById('companyVAT').value;
            if (companyVAT) companyHTML += '<p>TVA: ' + companyVAT + '</p>';
            document.getElementById('previewCompanyInfo').innerHTML = companyHTML;
            
            // Client
            var clientHTML = '';
            var clientName = document.getElementById('clientName').value;
            if (clientName) clientHTML += '<p><strong>' + clientName + '</strong></p>';
            var clientAddress = document.getElementById('clientAddress').value;
            if (clientAddress) clientHTML += '<p>' + clientAddress.replace(/\n/g, '<br>') + '</p>';
            var clientEmail = document.getElementById('clientEmail').value;
            if (clientEmail) clientHTML += '<p>' + clientEmail + '</p>';
            var clientPhone = document.getElementById('clientPhone').value;
            if (clientPhone) clientHTML += '<p>Tél: ' + clientPhone + '</p>';
            document.getElementById('previewClient').innerHTML = clientHTML || '<p>---</p>';
            
            // Livraison
            if (document.getElementById('differentDelivery').checked) {
                var deliveryAddress = document.getElementById('deliveryAddress').value;
                if (deliveryAddress) {
                    document.getElementById('previewDelivery').style.display = 'block';
                    document.getElementById('previewDeliveryAddress').innerHTML = '<p>' + deliveryAddress.replace(/\n/g, '<br>') + '</p>';
                } else {
                    document.getElementById('previewDelivery').style.display = 'none';
                }
            } else {
                document.getElementById('previewDelivery').style.display = 'none';
            }
            
            // Note (retirer bordure bas si remplie)
            var optNote = document.getElementById('optionalNote').value.trim();
            if (optNote) {
                document.getElementById('previewNote').textContent = optNote;
                document.getElementById('previewNote').style.display = 'block';
                document.getElementById('previewNote').className = 'preview-note with-content';
            } else {
                document.getElementById('previewNote').style.display = 'none';
            }
            
            // Dates
            var date = document.getElementById('docDate').value;
            document.getElementById('previewDate').textContent = date ? new Date(date).toLocaleDateString('fr-FR') : '---';
            
            var dueDate = document.getElementById('dueDate').value;
            document.getElementById('previewDueLabel').textContent = isInvoice ? 'Échéance' : 'Validité';
            document.getElementById('previewDue').textContent = dueDate ? new Date(dueDate).toLocaleDateString('fr-FR') : '---';
            
            // Lignes
            var linesHTML = '';
            if (lines.length === 0 || lines.every(function(l) { return !l.description; })) {
                linesHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">Aucune ligne</td></tr>';
            } else {
                lines.forEach(function(line) {
                    if (line.description) {
                        var lineHT = line.quantity * line.priceHT;
                        var discountAmount = lineHT * (line.discount / 100);
                        var lineHTAfterDiscount = lineHT - discountAmount;
                        
                        linesHTML += '<tr>';
                        linesHTML += '<td>' + line.description + '</td>';
                        linesHTML += '<td>' + line.quantity + '</td>';
                        linesHTML += '<td>' + line.priceHT.toFixed(2) + '</td>';
                        linesHTML += '<td>' + (line.discount > 0 ? line.discount + '%' : '-') + '</td>';
                        linesHTML += '<td>' + line.vat + '%</td>';
                        linesHTML += '<td>' + lineHTAfterDiscount.toFixed(2) + '</td>';
                        linesHTML += '</tr>';
                    }
                });
            }
            document.getElementById('previewLines').innerHTML = linesHTML;
            
            // Totaux
            var totalHT = 0;
            var totalVAT = 0;
            lines.forEach(function(line) {
                var lineHT = line.quantity * line.priceHT;
                var discountAmount = lineHT * (line.discount / 100);
                var lineHTAfterDiscount = lineHT - discountAmount;
                totalHT += lineHTAfterDiscount;
                totalVAT += lineHTAfterDiscount * (line.vat / 100);
            });
            var totalTTC = totalHT + totalVAT;
            
            document.getElementById('previewTotalHT').textContent = totalHT.toFixed(2) + ' €';
            document.getElementById('previewTotalVAT').textContent = totalVAT.toFixed(2) + ' €';
            document.getElementById('previewTotalTTC').textContent = totalTTC.toFixed(2) + ' €';
            
            // Acompte
            var deposit = parseFloat(document.getElementById('deposit').value) || 0;
            if (deposit > 0) {
                document.getElementById('previewDepositLine').style.display = 'block';
                document.getElementById('previewDeposit').textContent = deposit.toFixed(2) + ' €';
                document.getElementById('previewRemaining').textContent = (totalTTC - deposit).toFixed(2) + ' €';
            } else {
                document.getElementById('previewDepositLine').style.display = 'none';
            }
            
            // Échéance paiement
            var paymentTerms = document.getElementById('paymentTerms').value;
            document.getElementById('previewPaymentTerms').textContent = paymentTerms || '';
            
            // Mode paiement
            var paymentMode = document.getElementById('paymentMode').value;
            document.getElementById('previewPayment').textContent = paymentMode ? 'Paiement : ' + paymentMode : '';
            
            // Mention TVA
            var vatMention = document.getElementById('vatMention').value;
            var vatText = '';
            if (vatMention === 'article293b') {
                vatText = 'TVA non applicable, selon l\'article 293B du code général des impôts.';
            } else if (vatMention === 'autoliquidation') {
                vatText = 'TVA due par le preneur assujetti ; autoliquidation en application de l\'article 242 nonies A, I-13° de l\'annexe II au CGI.';
            }
            document.getElementById('previewVatMention').textContent = vatText;
            
            // Tampon PAYÉ
            if (isInvoice && document.getElementById('markAsPaid').checked) {
                document.getElementById('stampPaid').style.display = 'block';
            } else {
                document.getElementById('stampPaid').style.display = 'none';
            }
        }


        function generatePDF() {
            console.log('=== GÉNÉRATION PDF ===');
            
            var companyName = document.getElementById('companyName').value.trim();
            var clientName = document.getElementById('clientName').value.trim();
            var docNumber = document.getElementById('docNumber').value.trim();
            
            if (!companyName || !clientName || !docNumber) {
                alert('Veuillez remplir les champs obligatoires (*)');
                return;
            }
            
            if (lines.length === 0 || lines.every(function(l) { return !l.description; })) {
                alert('Veuillez ajouter au moins une ligne de prestation');
                return;
            }
            
            console.log('✓ Validation OK');
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('Bibliothèque PDF non chargée');
                }
                
                console.log('✓ jsPDF disponible');
                
                var jsPDF = window.jspdf.jsPDF;
                
                if (typeof jsPDF !== 'function') {
                    throw new Error('jsPDF invalide');
                }
                
                console.log('✓ Création PDF...');
                
                var doc = new jsPDF();
                var type = document.querySelector('input[name="docType"]:checked').value;
                var isInvoice = type === 'invoice';
                var theme = themes[document.getElementById('colorTheme').value];
                
                function hexToRgb(hex) {
                    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : { r: 0, g: 0, b: 0 };
                }
                
                var primaryRgb = hexToRgb(theme.primary);
                var y = 20;
                
                // Logo si présent - POSITIONS GAUCHE CORRIGÉES
                if (logoData) {
                    var logoPos = document.getElementById('logoPosition').value;
                    var logoSize = parseInt(document.getElementById('logoSize').value);
                    var logoOpacity = parseInt(document.getElementById('logoOpacity').value) / 100;
                    
                    // Créer image temporaire pour obtenir ratio
                    var tempImg = new Image();
                    tempImg.src = logoData;
                    
                    var aspectRatio = tempImg.width / tempImg.height;
                    var logoWidth = 10 * (logoSize / 100);
                    var logoHeight = logoWidth / aspectRatio;
                    
                    var logoX, logoY;
                    
                    if (logoPos === 'position2') {
                        // Position 2 : DESSUS - coin supérieur GAUCHE, AU-DESSUS des infos
                        logoX = 14; // Aligné à gauche (marge standard)
                        logoY = y;
                        y = logoY + logoHeight + 5; // Décaler infos entreprise EN-DESSOUS
                    } else if (logoPos === 'position3') {
                        // Position 3 : CENTRE - bord supérieur centré
                        logoX = (210 - logoWidth) / 2;
                        logoY = 12; // REMONTÉ (au lieu de 28)
                    } else {
                        // Position 1 : MARGE - coin supérieur GAUCHE, À CÔTÉ des infos
                        logoX = 14; // Aligné à gauche
                        logoY = y;
                        // Les infos entreprise commenceront à droite du logo
                        // On ne décale pas Y, les infos seront décalées en X
                    }
                    
                    // Afficher logo avec opacité
                    doc.saveGraphicsState();
                    doc.setGState(new doc.GState({ opacity: logoOpacity }));
                    doc.addImage(logoData, 'PNG', logoX, logoY, logoWidth, logoHeight);
                    doc.restoreGraphicsState();
                }
                
                // Header : Entreprise (gauche) + Titre (droite)
                var companyX = 14; // Position X par défaut
                
                // Si logo en position MARGE, décaler les infos à droite du logo
                if (logoData && logoPos === 'position1') {
                    companyX = 14 + logoWidth + 5; // Infos après le logo
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(companyName, companyX, y);
                y += 5;
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                
                var companyAddress = document.getElementById('companyAddress').value;
                if (companyAddress) {
                    doc.splitTextToSize(companyAddress, 80).forEach(function(line) {
                        doc.text(line, companyX, y);
                        y += 3.5;
                    });
                }
                
                var email = document.getElementById('companyEmail').value;
                if (email) {
                    doc.text(email, companyX, y);
                    y += 3.5;
                }
                
                var phone = document.getElementById('companyPhone').value;
                if (phone) {
                    doc.text('Tél: ' + phone, companyX, y);
                    y += 3.5;
                }
                
                var siret = document.getElementById('companySiret').value;
                if (siret) {
                    doc.text('SIRET: ' + siret, companyX, y);
                    y += 3.5;
                }
                
                var companyVAT = document.getElementById('companyVAT').value;
                if (companyVAT) {
                    doc.text('TVA: ' + companyVAT, companyX, y);
                }
                
                // Titre FACTURE (droite)
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.text(isInvoice ? 'FACTURE' : 'DEVIS', 196, 20, { align: 'right' });
                
                doc.setFontSize(10);
                doc.setTextColor(120);
                doc.text('N° ' + docNumber, 196, 27, { align: 'right' });
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                doc.text('Date: ' + new Date(document.getElementById('docDate').value).toLocaleDateString('fr-FR'), 196, 33, { align: 'right' });
                var dueDateLabel = isInvoice ? 'Échéance' : 'Validité';
                doc.text(dueDateLabel + ': ' + new Date(document.getElementById('dueDate').value).toLocaleDateString('fr-FR'), 196, 38, { align: 'right' });
                
                // Séparateur
                var startY = Math.max(y, 43) + 3;
                doc.setDrawColor(220);
                doc.setLineWidth(0.3);
                doc.line(14, startY, 196, startY);
                
                // Client
                startY += 5;
                var clientStartY = startY; // MÉMORISER position début client
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(120);
                doc.text('CLIENT', 14, startY);
                
                startY += 4;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                doc.text(clientName, 14, startY);
                startY += 4;
                
                var clientAddress = document.getElementById('clientAddress').value;
                if (clientAddress) {
                    doc.setFontSize(8);
                    doc.splitTextToSize(clientAddress, 80).forEach(function(line) {
                        doc.text(line, 14, startY);
                        startY += 3.5;
                    });
                }
                
                var clientEmail = document.getElementById('clientEmail').value;
                if (clientEmail) {
                    doc.text(clientEmail, 14, startY);
                    startY += 3.5;
                }
                
                var clientPhone = document.getElementById('clientPhone').value;
                if (clientPhone) {
                    doc.text('Tél: ' + clientPhone, 14, startY);
                    startY += 3.5;
                }
                
                // Livraison - ALIGNÉE AVEC CLIENT (CORRIGÉ)
                if (document.getElementById('differentDelivery').checked) {
                    var deliveryAddress = document.getElementById('deliveryAddress').value;
                    if (deliveryAddress) {
                        var deliveryY = clientStartY; // MÊME position Y que CLIENT
                        
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(7);
                        doc.setTextColor(120);
                        doc.text('LIVRAISON', 115, deliveryY);
                        deliveryY += 4;
                        
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(8);
                        doc.setTextColor(0);
                        doc.splitTextToSize(deliveryAddress, 80).forEach(function(line) {
                            doc.text(line, 115, deliveryY);
                            deliveryY += 3.5;
                        });
                    }
                }
                
                // Note optionnelle - TRAIT HAUT SEULEMENT (CORRIGÉ)
                var optNote = document.getElementById('optionalNote').value.trim();
                if (optNote) {
                    startY += 2;
                    
                    // Trait continu fin EN HAUT
                    doc.setDrawColor(220);
                    doc.setLineWidth(0.2);
                    doc.line(14, startY, 196, startY);
                    
                    startY += 4;
                    doc.setFontSize(8);
                    doc.setTextColor(0); // NOIR (au lieu de gris)
                    doc.setFont(undefined, 'normal');
                    doc.text(optNote, 14, startY);
                    startY += 2;
                    
                    doc.setFont(undefined, 'normal');
                }
                
                // Tableau
                startY += 4;
                doc.setDrawColor(220);
                doc.line(14, startY, 196, startY);
                startY += 5;
                
                // BANDEAU COULEUR LIGHT - HAUTEUR AUGMENTÉE (meilleur équilibre)
                var lightRgb = hexToRgb(theme.light);
                doc.setFillColor(lightRgb.r, lightRgb.g, lightRgb.b);
                doc.rect(14, startY - 5, 182, 8, 'F'); // Hauteur 8 (au lieu de 6)
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(7);
                doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.text('DESCRIPTION', 14, startY);
                doc.text('QTÉ', 115, startY, { align: 'right' });
                doc.text('P.U. HT', 138, startY, { align: 'right' });
                doc.text('REM.', 158, startY, { align: 'right' });
                doc.text('TVA', 173, startY, { align: 'right' });
                doc.text('TOTAL HT', 196, startY, { align: 'right' });
                
                // LIGNE FONCÉE EN BAS DU BANDEAU (collée)
                doc.setTextColor(0);
                doc.setDrawColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.setLineWidth(0.5);
                doc.line(14, startY + 3, 196, startY + 3); // Position +3 pour coller en bas du bandeau plus haut
                
                startY += 7; // ESPACEMENT APRÈS BANDEAU (au lieu de 5)
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(0);
                
                lines.forEach(function(line, index) {
                    if (line.description) {
                        // ESPACEMENT AVANT CHAQUE LIGNE (aération)
                        if (index > 0) {
                            startY += 2;
                        }
                        
                        var lineHT = line.quantity * line.priceHT;
                        var discountAmount = lineHT * (line.discount / 100);
                        var total = (lineHT - discountAmount).toFixed(2);
                        
                        var desc = doc.splitTextToSize(line.description, 90);
                        var descHeight = desc.length * 3.5;
                        
                        // ALIGNEMENT VERTICAL DES CHIFFRES (au milieu de la description)
                        var alignY = startY + (descHeight / 2) - 1;
                        
                        doc.text(desc, 14, startY);
                        doc.text(line.quantity.toString(), 115, alignY, { align: 'right' });
                        doc.text(line.priceHT.toFixed(2), 138, alignY, { align: 'right' });
                        doc.text(line.discount > 0 ? line.discount + '%' : '-', 158, alignY, { align: 'right' });
                        doc.text(line.vat + '%', 173, alignY, { align: 'right' });
                        doc.text(total, 196, alignY, { align: 'right' });
                        
                        startY += descHeight + 1;
                        
                        // LIGNE DE SÉPARATION FINE
                        doc.setDrawColor(230);
                        doc.setLineWidth(0.1);
                        doc.line(14, startY, 196, startY);
                    }
                });
                
                // Totaux - TOUJOURS BAS DE PAGE (CORRIGÉ)
                var totalsY = 240; // Position fixe
                
                doc.setDrawColor(220);
                doc.setLineWidth(0.3);
                doc.line(14, totalsY, 196, totalsY);
                totalsY += 5;
                
                var totalHT = 0;
                var totalVAT = 0;
                lines.forEach(function(line) {
                    var lineHT = line.quantity * line.priceHT;
                    var discountAmount = lineHT * (line.discount / 100);
                    var lineHTAfterDiscount = lineHT - discountAmount;
                    totalHT += lineHTAfterDiscount;
                    totalVAT += lineHTAfterDiscount * (line.vat / 100);
                });
                var totalTTC = totalHT + totalVAT;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text('Total HT:', 140, totalsY);
                doc.text(totalHT.toFixed(2) + ' EUR', 196, totalsY, { align: 'right' });
                totalsY += 5;
                
                // PAS DE LIGNE entre HT et TVA
                
                doc.text('Total TVA:', 140, totalsY);
                doc.text(totalVAT.toFixed(2) + ' EUR', 196, totalsY, { align: 'right' });
                totalsY += 8; // AUGMENTÉ (au lieu de 6) pour plus d'espace
                
                // SÉPARATION CLAIRE entre TVA et TTC
                doc.setDrawColor(200);
                doc.setLineWidth(0.3);
                doc.line(140, totalsY - 5, 196, totalsY - 5); // Position -5 (au lieu de -3) pour plus d'espace
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.text('Total TTC:', 140, totalsY);
                doc.text(totalTTC.toFixed(2) + ' EUR', 196, totalsY, { align: 'right' });
                doc.setTextColor(0);
                
                // PAS DE LIGNE après TTC
                
                var deposit = parseFloat(document.getElementById('deposit').value) || 0;
                if (deposit > 0) {
                    totalsY += 5;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.text('Acompte versé:', 140, totalsY);
                    doc.text(deposit.toFixed(2) + ' EUR', 196, totalsY, { align: 'right' });
                    totalsY += 5;
                    doc.setFont(undefined, 'bold');
                    doc.text('Reste à payer:', 140, totalsY);
                    doc.text((totalTTC - deposit).toFixed(2) + ' EUR', 196, totalsY, { align: 'right' });
                }
                
                // Tampon PAYÉ - CORRIGÉ (position et style)
                if (isInvoice && document.getElementById('markAsPaid').checked) {
                    doc.saveGraphicsState();
                    doc.setDrawColor(220, 38, 38);
                    doc.setLineWidth(3);
                    doc.setTextColor(220, 38, 38);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    
                    // Position bas droite
                    var stampX = 155;
                    var stampY = 265;
                    var stampW = 40;
                    var stampH = 15;
                    
                    // Rectangle
                    doc.rect(stampX, stampY - stampH/2, stampW, stampH);
                    
                    // Texte PAYÉ avec rotation
                    doc.text('PAYÉ', stampX + stampW/2, stampY + 2, { 
                        align: 'center',
                        angle: -8 
                    });
                    
                    doc.restoreGraphicsState();
                    doc.setTextColor(0);
                }
                
                // Footer - TOUJOURS EN BAS (CORRIGÉ)
                var footerY = 272; // Position fixe bas de page
                
                // LIGNE FINE AVANT FOOTER
                doc.setDrawColor(220);
                doc.setLineWidth(0.1);
                doc.line(14, footerY - 4, 196, footerY - 4); // Position -4 (au lieu de -2) pour plus d'espace
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);
                doc.setTextColor(100);
                
                var paymentTerms = document.getElementById('paymentTerms').value;
                if (paymentTerms) {
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0);
                    doc.text(paymentTerms, 14, footerY);
                    footerY += 3.5;
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100);
                }
                
                var paymentMode = document.getElementById('paymentMode').value;
                doc.text('Paiement : ' + paymentMode, 14, footerY);
                footerY += 3.5;
                
                var notes = document.getElementById('notes').value;
                if (notes) {
                    footerY += 2;
                    doc.setTextColor(0); // NOIR (au lieu de 100 = gris)
                    doc.setFontSize(7);
                    var noteLines = doc.splitTextToSize(notes, 180);
                    doc.text(noteLines, 14, footerY);
                    footerY += noteLines.length * 3;
                    doc.setTextColor(100); // Remettre gris pour le reste
                }
                
                var vatMention = document.getElementById('vatMention').value;
                if (vatMention === 'article293b') {
                    footerY += 2;
                    doc.setFont(undefined, 'bold'); // GRAS
                    var vatText = doc.splitTextToSize('TVA non applicable, selon l\'article 293B du code général des impôts.', 180);
                    doc.text(vatText, 14, footerY);
                    doc.setFont(undefined, 'normal'); // Remettre normal
                } else if (vatMention === 'autoliquidation') {
                    footerY += 2;
                    doc.setFont(undefined, 'bold'); // GRAS
                    var vatText = doc.splitTextToSize('TVA due par le preneur assujetti ; autoliquidation en application de l\'article 242 nonies A, I-13° de l\'annexe II au CGI.', 180);
                    doc.text(vatText, 14, footerY);
                    doc.setFont(undefined, 'normal'); // Remettre normal
                }
                
                console.log('✓ Contenu ajouté');
                console.log('✓ Sauvegarde...');
                
                var filename = (isInvoice ? 'Facture-' : 'Devis-') + docNumber + '.pdf';
                console.log('Nom fichier:', filename);
                
                // MÉTHODE BLOB FORCÉE (plus fiable cross-browser)
                try {
                    console.log('Création blob...');
                    var blob = doc.output('blob');
                    console.log('✓ Blob créé:', blob.size, 'bytes');
                    
                    var url = URL.createObjectURL(blob);
                    console.log('✓ URL créée:', url.substring(0, 50) + '...');
                    
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    console.log('✓ Lien ajouté au DOM');
                    
                    a.click();
                    console.log('✓ Clic simulé');
                    
                    setTimeout(function() {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log('✓ Nettoyage effectué');
                    }, 100);
                    
                    console.log('=== ✓ PDF TÉLÉCHARGÉ AVEC SUCCÈS ===');
                    alert('PDF téléchargé avec succès !\n\nVérifiez votre dossier Téléchargements.');
                    
                } catch (error) {
                    console.error('❌ ERREUR:', error);
                    alert('Erreur lors du téléchargement:\n\n' + error.message + '\n\nOuvrez la console (F12) pour plus de détails.');
                }
                
            } catch (error) {
                console.error('ERREUR:', error);
                alert('Erreur lors de la génération:\n\n' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('FlashFacture chargé');
            init();
        });
    </script>
</body>
</html>
